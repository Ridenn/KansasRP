<!DOCTYPE html>
<html lang="pt">
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!-- Site Metas -->
    <link rel="icon" href="images/fevicon/fevicon.jpg" type="image/gif" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Kansas</title>

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />

    <!-- fonts style -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- font awesome style -->
    <link href="css/font-awesome.min.css" rel="stylesheet" />

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="css/responsive.css" rel="stylesheet" />

    <link rel="stylesheet" href="western/store.spa.css">
    <link rel="stylesheet" href="western/bootstrap-grid.min.css" integrity="sha512-pkOzvsY+X67Lfs6Yr/dbx+utt/C90MITnkwx8X5fyKkBorWHJLlR3TmgNJs83URAR0GdejZZnjZdgYjzL/mtcQ==" crossorigin="anonymous">
    <link rel="stylesheet" href="western/all.min.css">
    <link rel="stylesheet" href="western/animate.min.css">
    <link rel="stylesheet" href="western/7762.css">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
      (function(){
          emailjs.init({
            publicKey: "k67wLtHDsrfg9Tu7G",
          });
      })();
    </script>
    
    <script src="western/vue@2.6.12"></script>
    <script src="western/axios.min.js"></script>
    <link href="data:text/css,%3Ais(%5Bid*%3D'google_ads_iframe'%5D%2C%5Bid*%3D'taboola-'%5D%2C.taboolaHeight%2C.taboola-placeholder%2C%23credential_picker_container%2C%23credentials-picker-container%2C%23credential_picker_iframe%2C%5Bid*%3D'google-one-tap-iframe'%5D%2C%23google-one-tap-popup-container%2C.google-one-tap-modal-div%2C%23amp_floatingAdDiv%2C%23ez-content-blocker-container)%20%7Bdisplay%3Anone!important%3Bmin-height%3A0!important%3Bheight%3A0!important%3B%7D" rel="stylesheet" type="text/css">
  </head>

  <body class="sub_page">

    <!-- Toasts -->
    <div class="toast-container">
      <div id="validCouponToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
          <div class="d-flex">
              <div class="toast-body">
                  Cupom <span id="validCouponName"></span> inserido com sucesso!
              </div>
          </div>
      </div>
      <div id="invalidCouponToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
          <div class="d-flex">
              <div class="toast-body">
                  Cupom <span id="invalidCouponName"></span> é inválido!
              </div>
          </div>
      </div>
    </div>

    <div class="hero_area_cart">
      <!-- header section strats -->
      <header class="header_section">
        <div class="container-fluid">
          <nav class="navbar navbar-expand-lg custom_nav-container ">
            <a href="index.html">
              <img src="images/kansas_logo.png" class="footer-logo" width="100" height="50">
            </a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class=""> </span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav categories">
                  <li class="nav-item">
                      <a class="nav-link" href="index.html">Início <span class="sr-only">(current)</span></a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="about.html">Sobre</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="vip_colaborador.html">VIP Colaborador</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="gold_colaborador.html">Gold Colaborador</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="fazendas.html">Fazendas</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="extras.html">Extras</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="properties.html">Imóveis</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="upgrade.html">Upgrade</a>
                  </li>
              </ul>
              <div class="user_optio_box">
                  <div class="social_box">
                    <a href="https://www.facebook.com" target="_blank">
                        <img src="images/facebook.png" alt="">
                    </a>
                    <a href="https://x.com/condadokansas" target="_blank">
                        <img src="images/x.png" alt="">
                    </a>
                    <a href="https://www.instagram.com/condadokansas" target="_blank">
                      <img src="images/instagram.png" alt="">
                    </a>
                    <a href="https://www.tiktok.com/@condadokansas" target="_blank">
                      <img src="images/tiktok.png" alt="">
                    </a>
                    <a href="https://discord.gg/dtbq78SPpn" target="_blank">
                        <img src="images/discord.png" alt="">
                    </a>
                    <a href="https://www.youtube.com" target="_blank">
                        <img src="images/youtube.png" alt="">
                    </a>
                  </div>
                  <a href="checkout.html" class="cart-link">
                      <img src="images/cart_ic.png" id="cart-icon" width="28" height="28">
                      <span id="cart-count" class="badge badge-pill badge-danger">0</span>
                  </a>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <!-- end header section -->
    </div>

    <div id="container">
      <div id="cart">
        <h1>Itens no Carrinho</h1>
        <div class="container">
          <table class="table carrinho">
            <thead>
              <tr>
                <th></th>
                <th>Produto</th>
                <th>Preço</th>
                <th>Quantidade</th>
                <th>Remover</th>
              </tr>
            </thead>
            <tbody id="cartList">
              <!-- Os itens do carrinho serão adicionados aqui -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="checkout-details" class="container mt-4">
      <h2>Detalhes de Checkout</h2>
      <form id="checkoutForm">
        <div class="form-group">
          <label for="fullName">Nome Completo:</label>
          <input type="text" class="form-control" id="fullName" name="fullName" required>
        </div>
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="form-group">
          <label for="serverId">ID do Servidor:</label>
          <input type="text" class="form-control" id="serverId" name="serverId" required>
        </div>
        <div class="form-group">
          <label for="paymentMethod">Método de Pagamento:</label>
          <select class="form-control" id="paymentMethod" name="paymentMethod" required>
            <option value="">Selecione</option>
            <option value="pix">PIX</option>
            <!--
            <option value="creditCard">Mercado Pago QR</option>
            <option value="boleto">Boleto Bancário</option>
            -->
          </select>
        </div>
        <div class="form-group" id="cpfGroup" style="display: none;">
          <label for="cpf">CPF:</label>
          <input type="text" class="form-control" maxlength="11" id="cpf" name="cpf">
          <p>(O CPF é obrigatório para o método de pagamento escolhido)</p>
        </div>
        <label for="termsCheckbox" class="checkbox-label">
          <input type="checkbox" id="termsCheckbox" required>
          <a href="politica-pagamentos.html" target="_blank">Eu li e estou de acordo com as políticas de doação deste site.</a>
        </label>
        <br>
        <input type="hidden" id="totalAmount" name="totalAmount" value="">
        <input type="hidden" id="paidAmount" name="paidAmount" value="">
        <input type="hidden" id="cartItems" name="cartItems" value="">
        <input type="hidden" id="couponValue" name="couponValue" value="">
        <button id="submitButton" type="submit" class="btn btn-primary" style="display: none;">Finalizar Doação</button>
      </form>
      <br><br><br><br>
    </div>

    <!-- footer section -->
  <footer class="footer_section">
    <div class="container">
      <div class="row">
        <div class="col-md-4 footer-col">
          <div class="footer_contact">
            <h4>Entre em Contato</h4>
            <div class="contact_link_box">
              <a href="https://discord.gg/dtbq78SPpn">
                <i class="fa fa-phone" aria-hidden="true"></i>
                <span>Discord</span>
              </a>
              <br>
              <a href="mailto:condadokansas@gmail.com">
                <i class="fa fa-envelope" aria-hidden="true"></i>
                <span>condadokansas@gmail.com</span>
              </a>
            </div>
          </div>
        </div>
        <div class="col-md-4 footer-col">
          <div class="footer_detail">
            <a href="index.html">
              <img src="images/kansas_logo.png" class="footer-logo" width="200" height="100">
            </a>
            <div class="social_box">
              <a href="https://www.facebook.com" target="_blank">
                <img src="images/facebook.png" alt="">
              </a>
              <a href="https://x.com/condadokansas" target="_blank">
                <img src="images/x.png" alt="">
              </a>
              <a href="https://www.instagram.com/condadokansas" target="_blank">
                <img src="images/instagram.png" alt="">
              </a>
              <a href="https://www.tiktok.com/@condadokansas" target="_blank">
                <img src="images/tiktok.png" alt="">
              </a>
              <a href="https://discord.gg/dtbq78SPpn" target="_blank">
                <img src="images/discord.png" alt="">
              </a>
              <a href="https://www.youtube.com" target="_blank">
                <img src="images/youtube.png" alt="">
              </a>
            </div>
          </div>
        </div>
        <div class="col-md-4 footer-col">
          <div class="footer_contact">
            <h4>Política de Doações</h4>
            <div class="contact_link_box">
              <a href="politica-pagamento.html" target="_blank">
                <i class="fa fa-info-circle" aria-hidden="true"></i>
                <span>Saiba mais</span>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-info">
        <p>
          &copy; <span id="displayYear"></span> Copyright Kansas - Todos os Direitos Reservados
        </p>
      </div>
    </div>
  </footer>  
  <!-- footer section -->

    <!-- Modal POLITICAS -->
    <div id="privacyModal" class="modal">
      <div class="modal-content">
        <span class="close-button" id="closeModal">&times;</span>
        <h2>Políticas de Doação
        </h2>
        <p>Você pode fazer contribuições mensais por 30 dias, o que lhe dará algumas vantagens durante esse período. Também é possível fazer doações para ajudar a manter o servidor.</p>
        <p>Essas contribuições não lhe isentam de seguir as regras do condado!</p>
        <p>Nós não oferecemos reembolsos de doações!</p>
        <p>Contribuições não dão o direito de desrespeitar membros da equipe ou outros jogadores!</p>
        <p>A venda de itens adquiridos com ouro do condado é proibida!</p>
        <p>Se houver inatividade das fazendas (falta de pagamento da taxa mensal em dólares do jogo até o dia 15), a prefeitura poderá tomar posse e vendê-las novamente.</p>
        <p>Ao fazer uma doação, você aceita automaticamente todas as diretrizes mencionadas acima!</p>
        <p>Para receber os itens relacionados à sua doação, é necessário abrir um ticket financeiro com o comprovante.</p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const cpfGroup = document.getElementById('cpfGroup');
        const cpfInput = document.getElementById('cpf');
        const submitButton = document.getElementById('submitButton');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const serverIdInput = document.getElementById('serverId');
        const totalAmountInput = document.getElementById('totalAmount');
        const paidAmountInput = document.getElementById('paidAmount');
        const cartItemsInput = document.getElementById('cartItems');
        const couponInput = document.getElementById('couponValue');

        paymentMethodSelect.addEventListener('change', () => {
            const selectedMethod = paymentMethodSelect.value;
            if (selectedMethod === 'pix' || selectedMethod === 'boleto') {
              cpfGroup.style.display = 'block';
              cpfInput.setAttribute('required', 'required');
            } else {
              cpfGroup.style.display = 'none';
              cpfInput.removeAttribute('required');
            }
            validateForm();
        });

        function validateForm() {
            const isTermsChecked = termsCheckbox.checked;
            const isPaymentMethodSelected = paymentMethodSelect.value !== '';
            const isFullNameValid = validateFullName(fullNameInput.value);
            const isEmailValid = emailInput.value.trim() !== '';
            const isServerIdValid = serverIdInput.value.trim() !== '';
            const isCpfValid = cpfGroup.style.display === 'none' || isValidCPF(cpfInput.value);

            if (isTermsChecked && isPaymentMethodSelected && isFullNameValid && isEmailValid && isServerIdValid && isCpfValid) {
              submitButton.style.display = 'inline-block';
            } else {
              submitButton.style.display = 'none';
            }
        }

        fullNameInput.addEventListener('input', validateForm);
        emailInput.addEventListener('input', validateForm);
        serverIdInput.addEventListener('input', validateForm);
        cpfInput.addEventListener('input', validateForm);
        termsCheckbox.addEventListener('change', validateForm);

        submitButton.addEventListener('click', (event) => {
            event.preventDefault();

            const couponInsertedValue = document.getElementById('couponCodeInput');

            // Preenche os campos invisíveis com os valores obtidos
            totalAmountInput.value = calculateTotalAmount();
            paidAmountInput.value = calculatePaidAmount();
            cartItemsInput.value = JSON.stringify(getCartItems());
            couponInput.value = (couponInsertedValue.value === '' || couponInsertedValue.value === null) ? 'NENHUM CUPOM' : couponInsertedValue.value;

            if (cpfGroup.style.display === 'block' && !isValidCPF(cpfInput.value)) {
              alert('CPF inválido!');
              return;
            }

            // Limpar o carrinho
            localStorage.removeItem('carrinho');

            const selectedMethod = paymentMethodSelect.value;
            let redirectUrl = '';

            if (selectedMethod === 'pix') {
                generatePixCode(totalAmountInput.value, paidAmountInput.value)
                redirectUrl = 'pix_sucesso.html';
            } else if (selectedMethod === 'boleto') {
                redirectUrl = 'boleto_sucesso.html';
            } else if (selectedMethod === 'outro') {
                redirectUrl = 'outra_pagina.html'; // Substitua 'outra_pagina.html' pela página desejada
            }
        });

        function validateFullName(name) {
            return name.trim().split(/\s+/).length >= 2;
        }

        function isValidCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, ''); // Remove qualquer caractere que não seja número

            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
              return false; // Verifica se o CPF tem 11 dígitos e não é uma sequência de números iguais
            }

            let sum = 0;
            let remainder;

            // Valida o primeiro dígito verificador
            for (let i = 1; i <= 9; i++) {
              sum += parseInt(cpf[i - 1]) * (11 - i);
            }
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf[9])) return false;

            // Valida o segundo dígito verificador
            sum = 0;
            for (let i = 1; i <= 10; i++) {
              sum += parseInt(cpf[i - 1]) * (12 - i);
            }
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf[10])) return false;

            return true;
        }

        function calculatePaidAmount() {
            const totalDisplay = document.getElementById('totalDisplay');

            if (!totalDisplay) {
              console.error('Elemento com ID "totalDisplay" não encontrado.');
              return 0;
            }

            // Obtém o texto do elemento, removendo caracteres não numéricos e ajustando o separador decimal
            const totalText = totalDisplay.textContent.replace(/[^\d,.-]/g, '');
            const totalValue = parseFloat(totalText.replace(',', '.'));

            // Verifica se a conversão foi bem-sucedida
            if (isNaN(totalValue)) {
              console.error('Não foi possível converter o texto em número:', totalText);
              return 0;
            }

            return totalValue;
        }

        function calculateTotalAmount() {
          let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
            let totalAmount = 0;

            carrinho.forEach(item => {
                totalAmount += item.productPrice * item.productQuantity;
            });

            return totalAmount.toFixed(2);
        }

        function getCartItems() {
            let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
            return carrinho.map(item => `Produto: ${item.productName}, Quantidade: ${item.productQuantity}, Preço: R$ ${item.productPrice.toFixed(2)}`).join('  •  ');
        }

        function generatePixCode(totalAmount, paidAmount) {
            // GERAR PIX PARA TESTE
            window.$openpix = window.$openpix || []; // priorize o objeto já instanciado
            window.$openpix.push(['config', { appID: 'Q2xpZW50X0lkX2ZhZTQwYTI5LTk4NGMtNDU1Yi05NTkwLTIzMDI1MDE2YmI1NzpDbGllbnRfU2VjcmV0X3ozRVRPbmNiSFpMakM0MU1HNU4zWUsrQlp2eFRubERoNWZFOUVCdmV1OWM9' }]);

            const unsubscribe = null;
            const gerarCorrelationIdUnico = (len, chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789') => [...Array(len)].map(() => chars.charAt(Math.floor(Math.random() * chars.length))).join('')
            const redirectUrl = 'index.html';

            window.$openpix.push([
              'pix',
              {
                value: paidAmount * 100, // em centavos
                correlationID: gerarCorrelationIdUnico(30),
                expiresIn: 1800, // 30 minutos em segundos
              },
            ]);

            const logEvents = (e) => {
              if (e.type === 'CHARGE_COMPLETED') {
                if (unsubscribe !== null) {
                  unsubscribe();
                }

                // Envio do formulário p/ email do Kansas aqui
                sendEmail(totalAmount, paidAmount, redirectUrl);
                console.log('a cobrança foi paga');
              }

              if (e.type === 'CHARGE_EXPIRED') {
                if (unsubscribe !== null) {
                  unsubscribe();
                }
                window.location.href = redirectUrl;
                console.log('a cobrança foi expirada');
              }

              if (e.type === 'ON_CLOSE') {
                if (unsubscribe !== null) {
                  unsubscribe();
                }
                console.log('o modal da cobrança foi fechado');
              }

              if (e.type === 'ON_ERROR') {
                if (unsubscribe !== null) {
                  unsubscribe();
                }
                window.location.href = redirectUrl;
                console.log('ocorreu um erro');
              }
            };

            // only register event listener when plugin is already loaded
            if (!!window.$openpix?.addEventListener) {
              const unsubscribe = window.$openpix.addEventListener(logEvents);

              // parar de escutar os eventos
              // unsubscribe();
            }
        }

        function sendEmail(totalAmount, paidAmount, redirectUrl) {
            let params = {
              fullName : document.getElementById("fullName").value,
              email : document.getElementById("email").value,
              cpf : document.getElementById("cpf").value,
              serverId : document.getElementById("serverId").value,
              paymentMethod : document.getElementById("paymentMethod").value,
              cartItems : document.getElementById("cartItems").value,
              totalAmount : totalAmount,
              paidAmount : parseFloat(paidAmount).toFixed(2),
              couponValue : document.getElementById("couponValue").value,
            }

            emailjs.send("service_o0ecb2m", "template_tdvkhl3", params).then((result) => {
                console.log(result.text);
                console.log('Email enviado com sucesso!');

                // Manda pra pág inicial após 3s
                executeWithDelay(() => {
                    console.log("Ação executada após 3 segundos");
                    window.location.href = redirectUrl;
                }, 3000);
            }, (error) => {
                console.log(error.text);
                alert('Falha ao enviar pedido. Tente novamente.');
            });
        }

        function executeWithDelay(action, delay) {
            setTimeout(action, delay);
        }

        var modal = document.getElementById('privacyModal');
        var closeButton = document.getElementById('closeModal');
        var privacyLink = document.querySelector('a[href="politica-pagamentos.html"]');
        
        // Abrir o modal
        privacyLink.addEventListener('click', function(event) {
          event.preventDefault(); // Impede o link de seguir o href
          modal.style.display = 'block';
        });
        
        // Fechar o modal
        closeButton.addEventListener('click', function() {
          modal.style.display = 'none';
        });
        
        // Fechar o modal se o usuário clicar fora do conteúdo
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    </script>

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/custom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js"></script>
    <script src="https://plugin.openpix.com.br/v1/openpix.js" async></script>

  </body>
</html>
